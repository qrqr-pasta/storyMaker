import streamlit as st
import random

# ページ設定
st.set_page_config(
    page_title="物語創作システム v3",
    page_icon="📚",
    layout="centered",  # モバイル対応のため変更
    initial_sidebar_state="expanded"
)

# スタイル設定
st.markdown("""
<style>
    .main-header {
        text-align: center;
        color: #4A90E2;
        font-size: 2.5rem;
        margin-bottom: 2rem;
    }
    .trope-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
        margin: 1rem 0;
        font-size: 1.2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .request-box {
        background: linear-gradient(135deg, #a8e6cf 0%, #81c784 100%);
        color: #1b5e20;
        padding: 1rem;
        border-radius: 10px;
        margin: 0.5rem 0;
    }
    .prompt-box {
        background: #f8f9fa;
        border: 2px solid #4A90E2;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    .info-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
        margin: 0.2rem;
    }
</style>
""", unsafe_allow_html=True)

# 物語要素データ - 全トロープ統合版(460個)
STORY_TROPES = [
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅰ. 物語の基本構造(30個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 1-A. 旅路の類型(10個)
    "探求の旅(失われたものを求める)",
    "下降と上昇(奈落から再生へ)",
    "円環の旅(出発点への帰還)",
    "逃避と追跡(追われる者の物語)",
    "越境(境界を越える)",
    "巡礼(聖地への道程)",
    "放浪(目的地なき旅)",
    "螺旋の旅(繰り返しながら変化)",
    "分岐の旅(選択による多重展開)",
    "内的な旅(精神の変容)",
    
    ## 1-B. 変化の類型(10個)
    "成長(未熟から成熟へ)",
    "堕落(高みから転落)",
    "変身(別の存在への変容)",
    "覚醒(眠れる力の開花)",
    "退行(進化の逆行)",
    "分裂(一から多へ)",
    "統合(多から一へ)",
    "循環(始まりと終わりの接続)",
    "停滞(変化の拒絶)",
    "消失(存在の希薄化)",
    
    ## 1-C. 葛藤の類型(10個)
    "対決(直接的衝突)",
    "駆け引き(間接的攻防)",
    "逃走(回避と追跡)",
    "潜入(内部からの侵食)",
    "包囲(外部からの圧迫)",
    "競争(同等者の争い)",
    "協力(共通目的)",
    "裏切り(信頼の破壊)",
    "和解(対立の解消)",
    "共生(相互依存)",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅱ. キャラクター原型(40個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 2-A. 主動者(10個)
    "探求者(未知を求める)",
    "復讐者(奪われたものを取り戻す)",
    "救済者(他者を救う)",
    "破壊者(秩序を壊す)",
    "創造者(新しきものを生む)",
    "守護者(既存を守る)",
    "統率者(集団を導く)",
    "反逆者(支配に抗う)",
    "犠牲者(選ばれし者)",
    "傍観者(巻き込まれる者)",
    
    ## 2-B. 対抗者(10個)
    "影(主人公の鏡像)",
    "門番(試練を課す)",
    "誘惑者(道を逸れさせる)",
    "裁定者(判断を下す)",
    "妨害者(進行を阻む)",
    "追跡者(執念深く追う)",
    "模倣者(真似る者)",
    "寄生者(依存する者)",
    "簒奪者(奪い取る者)",
    "虚像(実体なき敵)",
    
    ## 2-C. 補助者(10個)
    "導師(知恵を授ける)",
    "道化(真実を笑いで語る)",
    "仲介者(橋渡しをする)",
    "犠牲的協力者(身を捧げる)",
    "忠実な従者(無条件で従う)",
    "予言者(未来を示す)",
    "記録者(記憶を保つ)",
    "治療者(傷を癒す)",
    "供給者(必要なものを与える)",
    "証人(真実を知る者)",
    
    ## 2-D. 特殊な役割(10個)
    "二重スパイ(両陣営に属する)",
    "変化者(立場が変わる)",
    "触媒(自身は変わらず他を変える)",
    "象徴的存在(概念の具現)",
    "語り手(物語内の話者)",
    "観察者(メタ的視点)",
    "ループする者(時間を繰り返す)",
    "複数存在(分身・並行)",
    "消えゆく者(存在が希薄化)",
    "存在しない者(不在の影響者)",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅲ. 状況とシチュエーション(50個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 3-A. 時間的制約(10個)
    "タイムリミット(期限内に完遂)",
    "時間ループ(同じ時間の反復)",
    "時間逆行(過去への遡行)",
    "時間加速(急速な経過)",
    "時間停止(凍結した世界)",
    "時差(異なる時間の流れ)",
    "時間債務(未来を前借り)",
    "時間の分岐(パラレル)",
    "時間外存在(流れから外れる)",
    "時間の消失(記録されない)",
    
    ## 3-B. 空間的制約(10個)
    "閉鎖空間(出られない)",
    "迷宮(構造が複雑)",
    "縮小する空間(狭まる世界)",
    "拡大する空間(広がる世界)",
    "変化する空間(構造が不定)",
    "重層空間(多層の世界)",
    "境界領域(あちらとこちら)",
    "侵食される領域(浸食)",
    "孤立した空間(外部との断絶)",
    "無限空間(終わりなき広がり)",
    
    ## 3-C. 社会的状況(15個)
    "追放(共同体からの排除)",
    "隔離(意図的な分離)",
    "階級闘争(上下の対立)",
    "革命前夜(変革の予兆)",
    "崩壊する秩序(体制の瓦解)",
    "管理社会(自由の制限)",
    "無秩序(統制の不在)",
    "疑心暗鬼(相互不信)",
    "集団ヒステリー(群衆心理)",
    "魔女狩り(スケープゴート)",
    "身分逆転(上下の入れ替わり)",
    "仮面舞踏会(正体隠し)",
    "試験・選抜(選別される)",
    "競技・トーナメント(勝ち抜き)",
    "祭りと日常(ハレとケ)",
    
    ## 3-D. 関係性の動態(15個)
    "正体隠蔽(互いに素性を隠す)",
    "強制協力(敵同士の共闘)",
    "非対称な記憶(片方だけが覚えている)",
    "代理・影武者(他者として生きる)",
    "世代間継承(約束の受け渡し)",
    "感情同期(気持ちの共有)",
    "片面的関係(一方にしか認識されない)",
    "共依存(互いが互いの条件)",
    "記憶共有(同じ記憶を持つ)",
    "憎悪の絆(負の感情での結合)",
    "師弟逆転(教える者と学ぶ者の交代)",
    "追う者と追われる者の反転",
    "双子的対称(鏡のような関係)",
    "三角関係(三者の葛藤)",
    "連鎖する復讐(終わらぬ報復)",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅳ. 力学とメカニクス(60個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 4-A. 禁忌と制約(15個)
    "視覚の禁止(見てはならない)",
    "聴覚の禁止(聞いてはならない)",
    "発話の禁止(言ってはならない)",
    "接触の禁止(触れてはならない)",
    "摂食の禁止(食べてはならない)",
    "時間の制約(時刻までに)",
    "回数の制限(○回まで)",
    "順序の強制(手順を守る)",
    "名前のタブー(真名を隠す)",
    "境界の不可侵(越えてはならない)",
    "対価の法則(等価交換)",
    "三度目の法則(三回目は取り返せない)",
    "満月の呪い(周期的発動)",
    "誓約の拘束(約束の強制力)",
    "感謝の禁止(礼を言えば去る)",
    
    ## 4-B. 能力と代償(20個)
    "予知(未来を見る)",
    "追体験(過去を見る)",
    "共感覚(他者の感覚)",
    "読心(心を読む)",
    "真実視(真相を見抜く)",
    "一度だけの力(使い切り)",
    "時間巻き戻し(限定的)",
    "願望実現(代償あり)",
    "記憶操作(書き換え・消去)",
    "存在消去(いなかったことに)",
    "痛覚共有(苦痛の転嫁)",
    "寿命変換(時間を売買)",
    "感情具現化(気持ちが形になる)",
    "運命視認(宿命が見える)",
    "死の予知(死期を知る)",
    "人格分離(多重自我)",
    "肉体変容(形態変化)",
    "感覚剥奪(五感の喪失)",
    "記憶喪失の代わりに(何かを得る)",
    "人間性の喪失(力の代償)",
    
    ## 4-C. 空間・物体の性質(15個)
    "時間差のある場所(流れが違う)",
    "記憶が物質化する空間",
    "感情で変化する場所",
    "真実だけが響く空間",
    "嘘が形になる場所",
    "因果律崩壊領域",
    "観測で変わる空間",
    "入るたびに変化",
    "重力・物理法則の変異",
    "生と死の境界",
    "夢と現実の混在",
    "全可能性の同時存在",
    "所有物が意思を持つ",
    "道具の暴走",
    "魔法の品の副作用",
    
    ## 4-D. システムと法則(10個)
    "測定不能な力",
    "レベルアップ",
    "ランク・階級",
    "ポイント制",
    "ガチャ・ランダム要素",
    "スキルツリー",
    "隠しパラメータ",
    "バグ・抜け穴",
    "システムの矛盾",
    "ルールの書き換え",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅴ. 変容と変化(40個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 5-A. 身体的変容(15個)
    "異種への変身(人→動物等)",
    "サイズ変化(巨大化・縮小)",
    "老化・若返り",
    "性転換",
    "物質化(生物→無機物)",
    "透明化・実体化",
    "分裂・増殖",
    "融合・同化",
    "部分変容(一部のみ変化)",
    "段階的変容(徐々に)",
    "可逆的変化(戻れる)",
    "不可逆的変化(戻れない)",
    "脱皮・羽化(殻を破る)",
    "石化・凍結",
    "溶解・気化",
    
    ## 5-B. 精神的変容(15個)
    "記憶の喪失",
    "記憶の改竄",
    "記憶の移植",
    "人格の分裂",
    "人格の統合",
    "人格の交換",
    "感情の消失",
    "感情の増幅",
    "価値観の逆転",
    "洗脳・マインドコントロール",
    "覚醒(真の自己発見)",
    "狂気への転落",
    "悟りの境地",
    "トラウマの再体験",
    "解離と統合",
    
    ## 5-C. 存在論的変容(10個)
    "生→死→再生",
    "人間→概念",
    "実在→虚構",
    "個→集合意識",
    "物質→情報",
    "現実→記憶",
    "主体→客体",
    "観察者→被観察者",
    "原因→結果",
    "時間内→時間外",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅵ. 展開パターン(50個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 6-A. 逆転のパターン(15個)
    "弱者の逆転",
    "追放からの復讐",
    "死からの復活",
    "敗北からの勝利",
    "絶望から希望へ",
    "裏切り者の正体",
    "真実の発覚",
    "計画の裏の裏",
    "救世主が真の敵",
    "敵が真の味方",
    "最弱が最強",
    "無価値が至宝",
    "呪いが祝福",
    "毒が薬",
    "終わりが始まり",
    
    ## 6-B. 因果のパターン(15個)
    "自己成就予言",
    "回避しようとして実現",
    "善意が悪い結果",
    "悪意が良い結果",
    "努力が裏目",
    "怠惰が幸運",
    "復讐の連鎖",
    "恩の連鎖",
    "因果の逆転",
    "遡及的因果(結果が原因に)",
    "偶然の必然化",
    "必然の偶然化",
    "バタフライ効果",
    "ドミノ倒し",
    "ブーメラン(戻ってくる)",
    
    ## 6-C. 収束のパターン(10個)
    "全員集合",
    "真相の統合",
    "伏線の回収",
    "円環の完成",
    "分散の統一",
    "多視点の統合",
    "時間軸の収束",
    "パラレルの統一",
    "矛盾の解消",
    "すべてが繋がる",
    
    ## 6-D. 終結のパターン(10個)
    "完全勝利",
    "ピュロスの勝利(代償大)",
    "引き分け・均衡",
    "共倒れ",
    "完全敗北",
    "開かれた終わり",
    "円環的終わり(始まりに戻る)",
    "余韻を残す終わり",
    "どんでん返し",
    "読者への問いかけ",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅶ. 対立の構図(30個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 7-A. 二項対立(20個)
    "正義対悪",
    "秩序対混沌",
    "自由対束縛",
    "個人対集団",
    "理性対感情",
    "本能対文明",
    "自然対人工",
    "生対死",
    "変化対不変",
    "真実対虚偽",
    "表面対深層",
    "既知対未知",
    "過去対未来",
    "運命対自由意志",
    "愛対憎悪",
    "希望対絶望",
    "創造対破壊",
    "統合対分裂",
    "聖対俗",
    "日常対非日常",
    
    ## 7-B. 三項対立(10個)
    "善・悪・中立",
    "過去・現在・未来",
    "身体・精神・魂",
    "父・母・子",
    "支配者・反逆者・傍観者",
    "創造・維持・破壊",
    "真実・嘘・沈黙",
    "愛・憎悪・無関心",
    "記憶・忘却・改変",
    "理想・現実・妥協",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅷ. 象徴と記号(60個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 8-A. 境界の象徴(10個)
    "橋(渡る・渡らない)",
    "扉・門(開く・閉じる)",
    "川(隔てる)",
    "鏡(映す・反転)",
    "窓(内と外)",
    "壁(分断)",
    "カーテン・幕(隠蔽)",
    "井戸・穴(深淵への入口)",
    "階段(上昇・下降)",
    "トンネル(通過)",
    
    ## 8-B. 時間の象徴(10個)
    "時計(刻まれる時)",
    "砂時計(流れる時)",
    "暦(周期)",
    "日の出・日没(始まりと終わり)",
    "真夜中(境界の時)",
    "満月・新月(周期)",
    "季節の移ろい",
    "朽ちるもの(経年)",
    "永遠を示すもの(不変)",
    "凍結(時の停止)",
    
    ## 8-C. 変容の象徴(10個)
    "蛹・繭(変態)",
    "卵(誕生)",
    "種(潜在)",
    "脱皮した皮(脱却)",
    "羽根(飛翔)",
    "蝶(変容)",
    "蛇(再生)",
    "灰(消失)",
    "炎(浄化・破壊)",
    "水(流動・洗浄)",
    
    ## 8-D. 契約・束縛の象徴(10個)
    "鎖・縄(拘束)",
    "指輪(約束)",
    "鍵(解放・封印)",
    "印章・刻印(契約)",
    "首輪(従属)",
    "結び目(絆)",
    "糸(運命)",
    "契約書(合意)",
    "血の誓い(不可逆)",
    "呪いの品(永続)",
    
    ## 8-E. 知識の象徴(10個)
    "本(記録)",
    "地図(案内)",
    "鏡(真実を映す)",
    "目(認識)",
    "光(啓示)",
    "闇(無知)",
    "迷宮(複雑さ)",
    "鍵(解答)",
    "謎(問い)",
    "啓示(悟り)",
    
    ## 8-F. 数の象徴(10個)
    "零(無・空虚)",
    "一(唯一・孤独)",
    "二(対・鏡像)",
    "三(完成・試練)",
    "四(安定・世界)",
    "五(人間・五感)",
    "七(神秘・完全)",
    "十二(周期・完成)",
    "十三(不吉・超過)",
    "無限(終わりなき)",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅸ. テーマと問い(40個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 9-A. 存在の問い(10個)
    "私は誰か",
    "本物とは何か",
    "存在の証明",
    "記憶と自己同一性",
    "生きる意味",
    "死の意味",
    "魂の所在",
    "意識とは何か",
    "現実とは何か",
    "時間とは何か",
    
    ## 9-B. 道徳の問い(10個)
    "正義とは何か",
    "善悪の基準",
    "目的は手段を正当化するか",
    "復讐は正当か",
    "犠牲は美しいか",
    "赦しとは何か",
    "責任の所在",
    "自由意志と決定論",
    "個人と全体",
    "権利と義務",
    
    ## 9-C. 関係性の問い(10個)
    "愛とは何か",
    "信頼の根拠",
    "裏切りの意味",
    "孤独と孤立",
    "他者理解の可能性",
    "共感と同情",
    "依存と自立",
    "支配と服従",
    "家族とは何か",
    "友情とは何か",
    
    ## 9-D. 社会の問い(10個)
    "権力の正当性",
    "秩序と自由",
    "進歩とは何か",
    "伝統と革新",
    "平等と公正",
    "多数と少数",
    "内側と外側",
    "文明の代償",
    "科学技術の功罪",
    "理想社会の可能性",
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Ⅹ. 物語の技法(30個)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    ## 10-A. 視点と語り(10個)
    "一人称(主観)",
    "三人称(客観)",
    "神の視点(全知)",
    "複数視点(多面)",
    "信頼できない語り手",
    "メタフィクション(物語の自覚)",
    "劇中劇(入れ子)",
    "語り手の正体",
    "読者への語りかけ",
    "視点の転換",
    
    ## 10-B. 時間の操作(10個)
    "時系列通り",
    "逆順(結末から)",
    "非線形(バラバラ)",
    "並行(同時進行)",
    "フラッシュバック",
    "フラッシュフォワード",
    "時間の圧縮",
    "時間の引き延ばし",
    "省略と飛躍",
    "ループ構造",
    
    ## 10-C. 構成(10個)
    "起承転結",
    "三幕構成",
    "序破急",
    "円環構造",
    "対称構造",
    "多層構造",
    "パラレル構造",
    "モザイク構造",
    "フレーム構造",
    "開放構造",
]

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 総計: 約460個の普遍的トロープ要素
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


# セッション状態の初期化
if 'trope1' not in st.session_state:
    st.session_state.trope1 = None
if 'trope2' not in st.session_state:
    st.session_state.trope2 = None

# ヘッダー
st.markdown('<h1 class="main-header">📚 物語創作システム v3</h1>', unsafe_allow_html=True)
st.markdown('<div style="text-align: center; color: #666; margin-bottom: 2rem;">🎲 4層トロープ統合版 - 類型・上位・中間・下位すべてをフラットに選択</div>', unsafe_allow_html=True)

# 使い方の説明
with st.expander("💡 使い方", expanded=False):
    st.markdown("""
    ### このツールの使い方
    
    1. **トロープを選択**: 左サイドバーまたは画面中央のボタンで2つのトロープをランダム選択
    2. **追加リクエスト（任意）**: 特定のキャラクター、雰囲気、長さなどを指定できます
    3. **プロンプト生成**: 「物語プロンプト生成」ボタンを押す
    4. **Claudeに送信**: 生成されたプロンプトをコピーして、[claude.ai](https://claude.ai)に貼り付ける
    5. **物語を受け取る**: Claudeが短編小説を創作します
    
    #### トロープとは？
    物語の「型」や「要素」のことです。このツールは145個のトロープから2つをランダムに組み合わせ、
    意外性のある物語の種を作ります。
    
    #### 注意事項
    - このツールはプロンプト（指示文）を生成するだけです
    - 実際の物語生成にはClaude（AI）が必要です
    - Claude.aiは無料でも使用できます
    """)

# サイドバー
with st.sidebar:
    st.header("🎲 ランダム生成")
    
    if st.button("2つのトロープを生成", type="primary", use_container_width=True):
        # 重複を許して2つ選択
        st.session_state.trope1 = random.choice(STORY_TROPES)
        st.session_state.trope2 = random.choice(STORY_TROPES)
        st.success("✅ トロープを生成しました!")
        st.rerun()
    
    st.divider()
    
    st.header("📊 選択状況")
    if st.session_state.trope1:
        st.success(f"✅ トロープ1:\n{st.session_state.trope1}")
    else:
        st.error("❌ トロープ1: 未選択")
    
    if st.session_state.trope2:
        st.success(f"✅ トロープ2:\n{st.session_state.trope2}")
    else:
        st.error("❌ トロープ2: 未選択")
    
    st.divider()
    
    st.markdown("""
    <div style="font-size: 0.85rem; color: #666;">
    <strong>💡 ヒント</strong><br>
    物語類型、上位対立、中間設定、<br>
    小道具まで、あらゆる層からの<br>
    組み合わせで新しい物語が生まれます
    </div>
    """, unsafe_allow_html=True)

# メインコンテンツ
st.header("🎯 トロープ選択")

col1, col2 = st.columns(2)

# トロープ1
with col1:
    st.subheader("トロープ 1")
    
    if st.button("🎯 ランダム選択", key="random_trope1", use_container_width=True):
        st.session_state.trope1 = random.choice(STORY_TROPES)
        st.rerun()
    
    if st.session_state.trope1:
        st.markdown(f'<div class="trope-box">{st.session_state.trope1}</div>', unsafe_allow_html=True)
    else:
        st.info("「ランダム選択」ボタンを押してください")

# トロープ2
with col2:
    st.subheader("トロープ 2")
    
    if st.button("🎯 ランダム選択", key="random_trope2", use_container_width=True):
        st.session_state.trope2 = random.choice(STORY_TROPES)
        st.rerun()
    
    if st.session_state.trope2:
        st.markdown(f'<div class="trope-box">{st.session_state.trope2}</div>', unsafe_allow_html=True)
    else:
        st.info("「ランダム選択」ボタンを押してください")

# 追加リクエストセクション
st.divider()
st.header("💬 追加リクエスト(任意)")
user_request = st.text_area(
    "",
    placeholder="例:既存キャラクター「◯◯」を使用、特定の雰囲気にしたい、長さの指定など...",
    height=100,
    key="user_request"
)

if user_request:
    st.markdown(f'<div class="request-box"><strong>追加リクエスト:</strong><br>{user_request}</div>', unsafe_allow_html=True)

# プロンプト生成
st.divider()
st.header("🎭 物語プロンプト生成")

all_tropes_selected = st.session_state.trope1 and st.session_state.trope2

if st.button("📝 物語プロンプト生成", type="primary", disabled=not all_tropes_selected, use_container_width=True):
    request_section = ""
    if user_request.strip():
        request_section = f"\n\n## 追加リクエスト\n{user_request.strip()}"
    
    tropes_text = f"""1. **「{st.session_state.trope1}」**
2. **「{st.session_state.trope2}」**
"""
    
    prompt = f"""# 短編物語創作依頼

## 使用するトロープ(物語要素)
{tropes_text}
## 登場人物設定
**指示**: 選択されたトロープに最も適した魅力的なキャラクター(1人以上)を、AIが自由に設定してください。年代、職業、性格などを物語のテーマに合わせて選択し、読者が感情移入しやすいキャラクターを作成してください。登場人物の固有名刺は重複を避けるために一般的でない特徴的な名前にしてください。特に「美咲」は頻出する傾向なので、禁止します。{request_section}

## 創作指示
上記の2つのトロープを自然に組み合わせた短編小説を創作してください。
- 両方のトロープが物語に有機的に統合されているようにしてください
- トロープ同士の意外な組み合わせから生まれる独創性を活かしてください
- 文字数制限はありません(自然な長さで完結させてください)
- 読者が引き込まれる魅力的な物語に仕上げてください
- 意外性のある展開や結末を心がけてください"""
    
    st.markdown('<div class="prompt-box">', unsafe_allow_html=True)
    st.markdown("### 📋 生成されたプロンプト")
    st.code(prompt, language="markdown")
    st.markdown('</div>', unsafe_allow_html=True)
    
    st.text_area("コピー用(全選択してコピーしてください)", prompt, height=200)
    
    st.success("✅ プロンプトが生成されました!上記をコピーしてClaudeに送信してください。")
    
    # トロープの組み合わせ情報
    st.info(f"🎲 **今回の組み合わせ**: 「{st.session_state.trope1}」×「{st.session_state.trope2}」")

if not all_tropes_selected:
    st.warning("⚠️ 2つのトロープを選択してください。")

# 利用規約・免責事項
st.divider()
with st.expander("📜 利用規約・免責事項"):
    st.markdown("""
    ### 利用規約
    
    **1. このツールについて**
    - このツールは物語創作のためのプロンプト生成ツールです
    - 生成されたプロンプトをClaude（Anthropic社のAI）に送信することで物語が作成されます
    - このツール自体はAIを使用せず、プロンプトのテンプレートを提供するのみです
    
    **2. 著作権について**
    - 生成されたプロンプト：自由に使用・改変できます
    - AI生成された物語：Anthropic社の利用規約に従います
    - 商業利用をする場合は、[Anthropic社の利用規約](https://www.anthropic.com/legal/consumer-terms)を必ずご確認ください
    
    **3. 免責事項**
    - 生成される内容について、開発者は一切の責任を負いません
    - 不適切な内容が生成された場合、使用者の責任で対処してください
    - Claudeのコンテンツポリシーに違反する使用はおやめください
    - このツールの使用により生じたいかなる損害についても、開発者は責任を負いません
    
    **4. データの取り扱い**
    - このアプリはユーザーデータを一切保存しません
    - セッション終了後、すべての情報は自動的に削除されます
    - 外部サーバーへのデータ送信は行いません
    
    **5. その他**
    - このツールは予告なく変更・終了する場合があります
    - 本規約は予告なく変更される場合があります
    """)

# フッター
st.divider()
st.markdown(f"""
<div style="text-align: center; color: #666; margin-top: 2rem;">
    📚 物語創作システム v3 - 4層トロープ統合版<br>
    <span class="info-badge">トロープ総数: {len(STORY_TROPES)}個</span>
    <span class="info-badge">物語類型: 15個</span>
    <span class="info-badge">上位対立: 10個</span>
    <span class="info-badge">中間設定: 100個</span>
    <span class="info-badge">小道具: 20個</span>
</div>
""", unsafe_allow_html=True)

st.markdown("""
<div style="text-align: center; color: #666; margin-top: 1rem; font-size: 0.85rem;">
    ⚠️ 生成された物語を商業利用する場合は、
    <a href="https://www.anthropic.com/legal/consumer-terms" target="_blank">Anthropicの利用規約</a>
    をご確認ください
</div>
""", unsafe_allow_html=True)
